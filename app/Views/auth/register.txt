<!--MODIFICADO POR JAFETH J -->

<!-- LLamamos al template del login -->
<?= $this->extend('layouts/template_login'); ?>
<!-- Definimos la sección de contenido -->
<?= $this->section('content'); ?>

<div class="card shadow-lg form-signin">
    <div class="card-body p-5">
        <h1 class="fs-4 card-title fw-bold mb-4">Registro</h1>
        <form method="POST" action="<?= base_url('register'); ?>" autocomplete="off">
            <?= csrf_field(); ?>

            <div class="mb-3">
                <label class="mb-2" for="name">Nombre</label>
                <input type="text" class="form-control" name="name" id="name" value="<?= set_value('name') ?>" required autofocus>
            </div>

            <div class="mb-3">
                <label class="mb-2" for="email">Correo electrónico</label>
                <input type="email" class="form-control" name="email" id="email" value="<?= set_value('email') ?>" required>
            </div>

            <div class="mb-3">
                <label class="mb-2" for="user">Usuario</label>
                <input type="text" class="form-control" name="user" id="user" value="<?= set_value('user') ?>" required>
            </div>

            <div class="mb-3">
                <label for="password">Contraseña</label>
                <input type="password" class="form-control" name="password" id="password" required>
            </div>

            <div class="mb-3">
                <label for="repassword">Confirmar contraseña</label>
                <input type="password" class="form-control" name="repassword" id="repassword" required>
            </div>

            <div class="mb-3">
                <label for="provincia">Provincia</label>
                <select class="form-control" name="provincia" id="provincia" required>
                    <option value="">Seleccione provincia</option>
                    <?php foreach($provincias as $prov): ?>
                        <option value="<?= $prov['codigo_provincia'] ?>" 
                        <?= ($prov['codigo_provincia'] == ($selectedProvincia ?? '')) ? 'selected' : '' ?>>
                        <?= $prov['nombre_provincia'] ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>

            <div class="mb-3">
                <label for="distrito">Distrito</label>
                <select class="form-control" id="distrito" name="distrito" <?= empty($selectedProvincia) ? 'disabled' : '' ?>>
                    <option value="">Seleccione distrito</option>
                    <?php if (!empty($selectedProvincia)): ?>
                        <!-- Los distritos se cargarán por JavaScript -->
                    <?php endif; ?>
                </select>
            </div>

            <div class="mb-3">
                <label for="corregimiento">Corregimiento</label>
                <select class="form-control" id="corregimiento" name="corregimiento" <?= empty($selectedDistrito) ? 'disabled' : '' ?>>
                    <option value="">Seleccione corregimiento</option>
                    <?php if (!empty($selectedDistrito)): ?>
                        <!-- Los corregimientos se cargarán por JavaScript -->
                    <?php endif; ?>
                </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">
                Registrar
            </button>
        </form>

        <?php if (isset($validation)): ?>
            <div class="alert alert-danger my-3" role="alert">
                <?= $validation->listErrors(); ?>
            </div>
        <?php endif; ?>
    </div>
    <div class="card-footer py-3 border-0">
        <div class="text-center">
            <a href="<?= base_url('login') ?>">Iniciar sesión</a>
        </div>
    </div>
</div>

<script>
    //------------SCRIPT DE UBICACION
    // 1. Define una variable con la base URL
    const BASE_URL = window.location.origin + '/reclamosSugerencias/public';

    // 2. Función para cargar distritos
    async function cargarDistritos(codigoProvincia, distritoSeleccionado = '') {
        const distritoSelect = document.getElementById('distrito');
        
        if (!codigoProvincia) {
            distritoSelect.innerHTML = '<option value="">Seleccione distrito</option>';
            distritoSelect.disabled = true;
            return;
        }

        distritoSelect.innerHTML = '<option value="">Cargando...</option>';
        
        try {
            const response = await fetch(`${BASE_URL}/api/distritos/${codigoProvincia}`);
            
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            
            const data = await response.json();
            
            distritoSelect.innerHTML = '<option value="">Seleccione distrito</option>';
            
            if (data.length > 0) {
                data.forEach(d => {
                    const selected = d.codigo_distrito === distritoSeleccionado ? 'selected' : '';
                    distritoSelect.innerHTML += `<option value="${d.codigo_distrito}" ${selected}>${d.nombre_distrito}</option>`;
                });
                distritoSelect.disabled = false;
            } else {
                distritoSelect.innerHTML = '<option value="">No hay distritos</option>';
            }
        } catch (error) {
            console.error("Error al cargar distritos:", error);
            distritoSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    }

    // 3. Función para cargar corregimientos
    async function cargarCorregimientos(codigoProvincia, codigoDistrito, corregimientoSeleccionado = '') {
        const corregimientoSelect = document.getElementById('corregimiento');

        if (!codigoDistrito) {
            corregimientoSelect.innerHTML = '<option value="">Seleccione corregimiento</option>';
            corregimientoSelect.disabled = true;
            return;
        }

        corregimientoSelect.innerHTML = '<option value="">Cargando...</option>';
        
        try {
            const response = await fetch(`${BASE_URL}/api/corregimientos/${codigoProvincia}/${codigoDistrito}`);
            
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            
            const data = await response.json();
            
            corregimientoSelect.innerHTML = '<option value="">Seleccione corregimiento</option>';
            
            if (data.length > 0) {
                data.forEach(c => {
                    const selected = c.codigo_corregimiento === corregimientoSeleccionado ? 'selected' : '';
                    corregimientoSelect.innerHTML += `<option value="${c.codigo_corregimiento}" ${selected}>${c.nombre_corregimiento}</option>`;
                });
                corregimientoSelect.disabled = false;
            } else {
                corregimientoSelect.innerHTML = '<option value="">No hay corregimientos</option>';
            }
        } catch (error) {
            console.error("Error al cargar corregimientos:", error);
            corregimientoSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    }

    // 4. Event Listeners
    document.getElementById('provincia').addEventListener('change', function() {
        const codigoProvincia = this.value;
        cargarDistritos(codigoProvincia);
        // Resetear corregimiento cuando cambia la provincia
        document.getElementById('corregimiento').innerHTML = '<option value="">Seleccione corregimiento</option>';
        document.getElementById('corregimiento').disabled = true;
    });

    document.getElementById('distrito').addEventListener('change', function() {
        const codigoProvincia = document.getElementById('provincia').value;
        const codigoDistrito = this.value;
        cargarCorregimientos(codigoProvincia, codigoDistrito);
    });

    // 5. Cargar valores iniciales si existen
    document.addEventListener('DOMContentLoaded', function() {
        const provinciaSelect = document.getElementById('provincia');
        const selectedProvincia = '<?= $selectedProvincia ?? '' ?>';
        const selectedDistrito = '<?= $selectedDistrito ?? '' ?>';
        const selectedCorregimiento = '<?= $selectedCorregimiento ?? '' ?>';
        
        if (selectedProvincia) {
            provinciaSelect.value = selectedProvincia;
            cargarDistritos(selectedProvincia, selectedDistrito).then(() => {
                if (selectedDistrito) {
                    const distritoSelect = document.getElementById('distrito');
                    distritoSelect.value = selectedDistrito;
                    cargarCorregimientos(selectedProvincia, selectedDistrito, selectedCorregimiento);
                }
            });
        }
    });
</script>


<?= $this->endsection(); ?>

<!--MODIFICADO POR JAFETH J -->